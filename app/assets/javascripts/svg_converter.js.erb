$(document).bind('page:change', function(e) {

    d3.select("#save").on("click", function() {
        svg_converter("frame");
    })

    $(".svg_export").click(function() {
        if($("#calendar_pies").length > 0) {
            svg_converter("doc");
        } else {
            $("iframe").contents().find("#save").trigger("click");
        }
    })

    function svg_converter(doc) {
        var html, width, height;
        if(doc == "frame") {
            html = d3.select("#chart").node().innerHTML.split('</svg>')[0] + "</svg>";
            width = d3.select("#chart svg").attr("width");
            height = d3.select("#chart svg").attr("height");
        } else if(doc == "doc") {
            html = d3.select("#calendar_pies").node().innerHTML.split('</svg>')[0] + "</svg>";
            width = d3.select("svg").attr("width");
            height = d3.select("svg").attr("height");
        }

        console.log(html);

        // get CANVAS image and convert it to PNG
        d3.select("canvas").attr("width", width).attr("height", height);
        var canvas = document.querySelector("canvas");
        console.log(canvas);
        var context = canvas.getContext("2d");

        var img_png = new Image();
        img_png.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(html)));
        img_png.onload = img_load();
        function img_load() {

            context.drawImage(img_png, 0, 0);
            var canvasdata = canvas.toDataURL("image/png");

            var a = document.createElement("a");
            a.download = "sample.png";
            a.href = canvasdata;
            a.click();
        }
    }
})