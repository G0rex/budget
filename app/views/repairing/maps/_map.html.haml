-# http://geojson.org/geojson-spec.html#examples
-# http://www.rubydoc.info/gems/rgeo-geojson/frames

-# https://github.com/alexreisner/geocoder
-# http://railscasts.com/episodes/273-geocoder

= stylesheet_link_tag 'leaflet/leaflet.css', :media => 'all'

= javascript_include_tag "leaflet/leaflet.js"
= javascript_include_tag "leaflet/leaflet-routing-machine.js"

:css
  #map {
    width: 100%;
    height: 600px;
    /*margin: 0;*/
    /*padding: 0;*/
  }

#map

:javascript

  $(document).ready(function() {
    $.when(
      $.getScript( "/assets/leaflet/leaflet.js" ),
      $.getScript( "/assets/leaflet/leaflet-routing-machine.js" ),
      $.Deferred(function( deferred ){
          $( deferred.resolve );
      })
    ).done(function(){

      var map = L.map('map', { scrollWheelZoom : false} ).setView([49.2336, 28.45514], 8)

      window.lmap = map
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 17,
        id: 'begemot.mbl2go4k',
        accessToken: 'pk.eyJ1IjoiYmVnZW1vdCIsImEiOiJlMjk1ODk0MDIzOTgxODUxNzFjNDk5YTBhNGNmNjQ3YyJ9.N5HyCJcDWeQGJcqCl1nHVQ'
      }).addTo(map);

      L.Icon.Default.imagePath = '/assets/leaflet/images'


      var popup = L.popup();
      function onMapClick(e) {
          popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
      }

      map.on('click', onMapClick);


      $.ajax({
        method: 'get',
        url: '#{geo_json_repairing_map_path(@repairing_map)}',
        dataType: 'json',
      })
      .done(function (data) {
        //geojson = $.parseJSON(data)
        console.log(data)
        //map.featureLayer.setGeoJSON(geojson)
      })
      .fail(function () {
      });


      // routing machine
      var router = L.Routing.osrm()
      window.lrouter = router


      //var polygon = L.polyline(
      //  L.Routing.waypoint(
      //    [
      //      L.latLng(49.18125, 28.32413),
      //      L.latLng(49.22926, 28.45871),
      //    ]
      //  ).waypoints
      //).addTo(map);



      //routeControl = L.Routing.waypoint(
      //  [
      //    L.latLng(49.18125, 28.32413),
      //    L.latLng(49.22926, 28.45871),
      //  ]
      //).addTo(map);
      //
      //console.log(L.Routing.Itinerary)
      //console.log(routeControl.getWaypoints())

      //var rlayer = L.layerGroup([routing]);
      //map.removeLayer(rlayer)
    })

  });
