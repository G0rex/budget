= render partial: 'map_ukraine'
#embed_code.pull-right
  = render partial: 'embed_code'

:javascript

  $(document).ready(function() {

    var embed_code = aMapEmbedCode();
    var src = 'http://' + window.location.host + "/repairing/maps/frame/6/";
    embed_code.initialize({width: '100%', height: '800px', el_id: "#embed_code", src: src});

    var category = "all", town;

    var aRepairMap = RepairMap({
      zoom: 6,
      minZoom: 5,
      maxZoom: 14,
      bounds: [ [47.54677, 21.44531], [52.32182, 41.52832]],
      scrollWheelZoom: true
    })

    // add markers
    $.ajax({
      method: 'get',
      url: '#{repairing_geo_json_path}',
      dataType: 'json',
    })
    .done(function (data) {
      aRepairMap.addGeoJsonPoints(data, getPoint, {
        clustered: false,
        style: {
          opacity: 0.8,
        },
        hoverStyle: {
          opacity: 1,
        },
        featureClickCallback: onFeatureClick,
        getMapPopupContent: getMapPopupContent,
        getInfoContent: getInfoContent,
        selectPath: false,
        getPoint: getPoint
      })
      aRepairMap.addCategoryControl(JSON.parse('#{@categories.to_json}'));
      $('#category_btns .btn').on("click",function(){
        if($(this).hasClass('active')){
          $('#category_btns .btn').removeClass('active');
          $('#category_title').html('');
          category = "all";
          aRepairMap.addCategoryLayer(category);
        } else {
          $('#category_btns .btn').removeClass('active');
          $(this).addClass('active');
          $('#category_title').html($(this).attr('title'));
          category = $(this).data('id');
          aRepairMap.addCategoryLayer(category);
        }
      })
      $('#map_town').select2({
        sortResults: function(results, container, query) {
          if (query.term) {
              // use the built in javascript sort function
              return results.sort(function(a, b) {
                  if (a.text.length > b.text.length) {
                      return 1;
                  } else if (a.text.length < b.text.length) {
                      return -1;
                  } else {
                      return 0;
                  }
              });
          }
          return results;
      },
        allowClear: true,
        multiSelect: false,
        multiple: false,
        minimumInputLength: 2,
        placeholder: "Обрати місто",
        width: '100%',
        ajax: {
          url: '#{search_for_towns_town_path}',
          dataType: 'json',
          quietMillis: 250,
          data: function (term, page) {
            return {
              query: term, // search term
            };
          },
          results: function (data, page) {
            return { results: data };
          },
          cache: true
        },
      }).on("change", function(){
        town = $(this).val();
        aRepairMap.addTownLayer(town);
        /*aRepairMap.map.setView(new L.LatLng(39, 40), 14);*/
      });
    })
    .fail(function () {
    });


    var HouseIcon = L.Icon.extend({ options: { iconSize: [32, 28] }});
    var RoadIcon = L.Icon.extend({ options: { iconSize: [32, 28] }});

    var icons = {}
    icons.house = new HouseIcon({iconUrl: '/assets/repairing/repair_house_small.png'})
    icons.road = new RoadIcon({iconUrl: '/assets/repairing/repair_road_small.png'})

    function getPoint(properties) {
      var point = {}
      switch (properties.repair) {
        case 'house':
          point.icon = icons.house
          break
        case 'road':
          point.icon = icons.road
          break
        default:
          point.icon = new L.Icon.Default()
          break
      }

      return point
    }

    function onFeatureClick(feature, popup) {
    }

    function getMapPopupContent(e) {
      var content = e.latlng.toString()
      return content
    }

    function getInfoContent(properties) {
      var content = "";
      if(properties != "Ukraine") {
      content += '<div class="popup">' +
                  '<h3>' + properties.title + '</h3>' +
                  '<p>' + properties.address + '</p>' +
                  '<p>' + properties.amount + '</p>' +
                 '</div>';
      }
      return content;
    }

    $('#town_select').select2({
      sortResults: function(results, container, query) {
        if (query.term) {
            // use the built in javascript sort function
            return results.sort(function(a, b) {
                if (a.text.length > b.text.length) {
                    return 1;
                } else if (a.text.length < b.text.length) {
                    return -1;
                } else {
                    return 0;
                }
            });
        }
        return results;
    },
      allowClear: true,
      multiSelect: false,
      multiple: false,
      minimumInputLength: 2,
      placeholder: "Обрати місто",
      width: '100%',
      ajax: {
        url: '#{search_for_towns_town_path}',
        dataType: 'json',
        quietMillis: 250,
        data: function (term, page) {
          return {
            query: term, // search term
          };
        },
        results: function (data, page) {
          return { results: data };
        },
        cache: true
      },
    }).on("change", function(){
      set_frame_url($(this).val(), $('#zoom_select').val());
      /*aRepairMap.map.setView(new L.LatLng(39, 40), 14);*/
    });

    $('#zoom_select').on("change", function(){
      set_frame_url($('#town_select').val(), $(this).val());
    })

    function set_frame_url(town_id, zoom){
      var src = 'http://' + window.location.host + "/repairing/maps/frame/" + zoom + "/" + town_id;
      embed_code.set_iframe(src);
    }

  })