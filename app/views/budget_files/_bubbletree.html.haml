-#https://github.com/okfn/bubbletree


= stylesheet_link_tag "bubbletree.css"
= javascript_include_tag "jquery-1.5.2.min.js"
= javascript_include_tag "jquery.history.js"
= javascript_include_tag "raphael.js"
= javascript_include_tag "vis4.js"
= javascript_include_tag "Tween.js"
= javascript_include_tag "bubbletree.js"
= javascript_include_tag "cofog.js"

.bubbletree-wrapper
  .info.pull-right
  .bubbletree
  .bubbletree_tooltip

:javascript

  $(document).ready(function() {
    var width = $('body').width();
    height = width * .35

    $('.bubbletree').height(height)

    d3.json("/budget_files/get_bubbletree_data/#{budget_file_id}", function(data) {
      new BubbleTree({
          data: data,
          container: '.bubbletree-wrapper .bubbletree',
          tooltip: function(a) {
            if (a.type == 'HIDE' || a.node.title == null) {
              $('.bubbletree_tooltip').html('').css('display', 'none')
            } else {
              console.log(a)
              tooltip = "<div class='title'>" + a.node.title + "</div>"
              $('.bubbletree_tooltip')
               .css("left", a.mousePos.x)
               .css("top", a.mousePos.y + 150)
               .css('display', 'block')
               .html(tooltip)
            }
          },
          nodeClickCallback: function(node) {
            title = node.title || ''
            div = "<div class='title'>" + title + "</div>"
              + "<h4 class='code' title='Пояснення............'>Код: " + node.label + "</h4>"
              + "<h3 class='amount'>" + node.famount + "</h3>"

            if (node.description) {
              div = div + "<hr/>" +  "<div class='description'>" + node.description + "</div>"
            }

            $('.bubbletree-wrapper .info').html(div)
          }
      });
    })
  });
