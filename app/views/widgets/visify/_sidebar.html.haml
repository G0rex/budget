#sidebar.col-xs-4
  #text
  = render partial: 'sidebar_chart', :locals => { budget_file_id: budget_file_id }
  #table

:javascript

  function aSidebar(aContainer) {
    var chart
    // draw table
    function renderTable(node) {
      if (node.children == undefined)
        return ''

      div = '<table class="table table-hover">'
      $.each(node.children, function( index, value ) {
        div += '<tr>'
          + '<td><div style="float: left; margin-right: 10px; margin-top: 4px; width:10px; height:10px; background-color:' + value.color + '"></div>'
          + value.label + '</td>'
          + '<td>' + aVisify.helpers.formatNumber(value.amount) + '</td>'
          + '<td>' + aVisify.helpers.getPercentageString(value, value.parent.amount) + '</td>'
          + '</tr>'
      });
      div += '</table>'
      return div
    }

    return {
      container: aContainer,

      initialize: function(height){
        $(aContainer + ' #sidebar').height(height)

        chart = aSidebarChart()
        chart.initialize(250)
      },

      hide: function(){
        $(aContainer + ' #sidebar #text').html('')
        $(aContainer + ' #sidebar #table').html('')
        chart.hide()
      },
      show: function(node){
        label = node.label || ''

        if (node.parent && node.amount <= node.parent.amount) {
          percentage = aVisify.helpers.getPercentageString(node, node.parent.amount)
          percParentTitle = ' від ' + node.parent.label || ''
        }
        else {
          percentage = '100%'
          percParentTitle = ''
        }

        div = "<h3>" + label + "</h3>"

        div += "<h3>" + aVisify.helpers.formatNumber(node.amount) + " - <span class='percentage'>" + percentage + "<small>" + percParentTitle + "</small></spqn></h3>"

        if (node.description) {
          div += "<hr/>" +  "<div class='description'>" + node.description + "</div>"
        }

        $(aContainer + ' #sidebar #text').html(div)
        $(aContainer + ' #sidebar #table').html(renderTable(node))

        chart.show(node.children)
      }
    }
  }