-#https://github.com/okfn/bubbletree

= javascript_include_tag "jquery.history.js"
= javascript_include_tag "raphael.js"
= javascript_include_tag "vis4.js"
= javascript_include_tag "Tween.js"
= javascript_include_tag "bubbletree.js"
= javascript_include_tag "cofog.js"


.bubbletree
  = render partial: 'tree_chart_modify', :locals => { budget_file_id: @budget_file.id }

:javascript
  var aTreeChart = function (aContainer) {
    var self;
    var bubbleTree, centerNode = null;

    function clear() {
      d3.select(aContainer + ' #chart').selectAll("*").remove();
    }

    function nodeClick(node) {
      centerNode = node;
      self.clickCallback(node);
    }

    return {
      initialize: function(options) {
        self = this;
        self.clickCallback = options.clickCallback;

        $(aContainer + ' #chart').width(options.width).height(options.height);
      },
      show: function(data) {
        clear();

        if (!data) return;

        bubbleTree = new BubbleTree({
            data: data,
            container: aContainer + ' #chart',
            sortBy: 'label',
            bubbleType: ['icon', 'plain'],
            centerNode: centerNode,
            nodeClickCallback: nodeClick,
            tooltipCallback: function(e) {
              var tooltip = $('.bubbletree #svg_tooltip');
              if(e.type == "SHOW") {
                tooltip.find(".tooltip-content").html("<span class='tooltip-title'>" + e.node.label + "</span><br/>\
                                                       <span class='tooltip-subcontent'>\
                                                       план: " + aVisify.helpers.formatNumber(e.node.amount) + "<br/>\
                                                       факт: " + aVisify.helpers.formatNumber(e.node.amount_fact || 0) + "<br/>\
                                                       </span>")
                tooltip.addClass("my-hover correct_coords").css('left', e.bubblePos.x).css('top', e.bubblePos.y );
              } else {
                tooltip.removeClass("my-hover");
              }

            }
        });
      },
      selectNode: function (node) {
        bubbleTree.navigateTo(node);
      },
      set_centerNode: function(node) {
        centerNode = node;
      },
      getCenterNode: function(node) {
        return bubbleTree.getCenterNode("bubble", node);
      },
      current_node: function() {
        return centerNode;
      }
    }
  }

