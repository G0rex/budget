-#https://github.com/okfn/bubbletree

= javascript_include_tag "jquery.history.js"
= javascript_include_tag "raphael.js"
= javascript_include_tag "vis4.js"
= javascript_include_tag "Tween.js"
= javascript_include_tag "bubbletree.js"
= javascript_include_tag "cofog.js"

.bubbletree
  #sidebar.col-xs-3
  #chart

:javascript

  $(document).ready(function() {
    var width = $(document).width() - $('#sidebar').width() - 50;
    height = $(document).height() - 120

    var totalSize;

    $('.bubbletree #chart').width(width).height(height)

    var tooltip = d3.select(".bubbletree").append("div")
        .attr("id", "tooltip")
        .style("opacity", 0);

    var tooltipTimer
    d3.json("/widgets/visify/get_bubbletree_data/#{budget_file_id}", function(data) {
      new BubbleTree({
          data: data,
          container: '.bubbletree #chart',

          sortBy: 'label',

          bubbleType: ['icon', 'plain'],

          tooltip: function(a) {
            if (tooltipTimer) {
              clearTimeout(tooltipTimer)
            }

            if (a.type == 'HIDE') {
              tooltip.transition()
                .duration(200)
                .style("opacity", 0)
              tooltip.style("display", 'none')
            } else {
              tooltipTimer = setTimeout(function() {
                tooltip.html(getTooltipHtml(a.node))
                 .style("left", a.mousePos.x + "px")
                 .style("top", a.mousePos.y + "px")
                 .style("display", 'block')
                tooltip.transition()
                 .duration(200)
                 .style("opacity", .9)
              }, 200)
            }
          },
          nodeClickCallback: function(node) {
            $('.bubbletree #sidebar').html(getItemInfoHtml(node))
          }
      });

      totalSize = data.size;
    })

    function getItemInfoHtml(node) {
      if (node.parent && node.size < node.parent.size)
        percentage = (100 * node.size / node.parent.size).toPrecision(3)
      else
        percentage = '100'

      label = node.label || ''
      div = "<h3>" + label + "</h3>"
        + "<h3 class='percentage'>" + percentage + "%</h3>"
        + "<h4 class='amount'>" + node.size.toLocaleString() + " грн</h4>"

      if (node.description) {
        div = div + "<hr/>" +  "<div class='description'>" + node.description + "</div>"
      }

      return div
    }

    function getTooltipHtml(node) {
      if (node.parent && node.size < node.parent.size)
        percentage = (100 * node.size / node.parent.size).toPrecision(3)
      else
        percentage = '100'

      label = node.label || ''
      div = "<h3 class='percentage'>" + percentage + "% </h3> <h5> " + node.size.toLocaleString() + " грн</h5>"
        + "<hr/>"
        + "<div>" + label + "</div>"

      return div
    }
  });
